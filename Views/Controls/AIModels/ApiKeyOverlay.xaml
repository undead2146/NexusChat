<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:NexusChat.Core.ViewModels"
             xmlns:converters="clr-namespace:NexusChat.Views.Converters"
             x:Class="NexusChat.Views.Controls.ApiKeyOverlay"
             x:Name="ApiKeyOverlayRoot">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:GreaterThanConverter x:Key="GreaterThanConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid IsVisible="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=IsVisible}"
          BackgroundColor="#80000000">
        <Border BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2D2D2D}"
               StrokeShape="RoundRectangle 16,16,16,16"
               Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#555555}"
               StrokeThickness="1"
               WidthRequest="400"
               HeightRequest="600"
               VerticalOptions="Center"
               HorizontalOptions="Center"
               Margin="20">
            <ScrollView Padding="24">
                <StackLayout Spacing="20">
                    <!-- Header -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="Manage API Keys"
                               FontSize="20"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#ffffff}" />
                        
                        <Button Grid.Column="1"
                                Text="&#xf00d;"
                                FontFamily="FontAwesome-Solid"
                                FontSize="16"
                                TextColor="{AppThemeBinding Light=#666666, Dark=#cccccc}"
                                BackgroundColor="Transparent"
                                BorderColor="Transparent"
                                WidthRequest="32"
                                HeightRequest="32"
                                CornerRadius="16"
                                Padding="0"
                                Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=CloseOverlayCommand}" />
                    </Grid>
                    
                    <!-- Existing API Keys Section -->
                    <StackLayout IsVisible="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=ExistingApiKeys.Count, Converter={StaticResource GreaterThanConverter}, ConverterParameter=0}">
                        <Label Text="Current API Keys:"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#ffffff}"
                               Margin="0,0,0,12" />
                        
                        <CollectionView ItemsSource="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=ExistingApiKeys}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Border BackgroundColor="{AppThemeBinding Light=#f8f9fa, Dark=#404040}"
                                            StrokeShape="RoundRectangle 8,8,8,8"
                                            Stroke="{AppThemeBinding Light=#e0e0e0, Dark=#555555}"
                                            StrokeThickness="1"
                                            Padding="16,12"
                                            Margin="0,4">
                                        <Grid ColumnDefinitions="Auto,*,Auto" 
                                              ColumnSpacing="12">
                                            
                                            <!-- Provider Icon -->
                                            <Border Grid.Column="0"
                                                   WidthRequest="36"
                                                   HeightRequest="36"
                                                   StrokeShape="RoundRectangle 18,18,18,18"
                                                   BackgroundColor="{AppThemeBinding Light=#28a745, Dark=#20c997}">
                                                <Label Text="&#xf084;"
                                                       FontFamily="FontAwesome-Solid"
                                                       FontSize="16"
                                                       TextColor="White"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center" />
                                            </Border>
                                            
                                            <!-- Provider details -->
                                            <StackLayout Grid.Column="1" 
                                                        VerticalOptions="Center"
                                                        Spacing="2">
                                                <Label Text="{Binding .}"
                                                       FontSize="16"
                                                       FontAttributes="Bold"
                                                       TextColor="{AppThemeBinding Light=#333333, Dark=#ffffff}" />
                                                <Label Text="{Binding ., StringFormat='API key configured for {0}'}"
                                                       FontSize="12"
                                                       TextColor="{AppThemeBinding Light=#666666, Dark=#cccccc}" />
                                            </StackLayout>
                                            
                                            <!-- Remove Button -->
                                            <Button Grid.Column="2"
                                                    Text="&#xf00d;"
                                                    FontFamily="FontAwesome-Solid"
                                                    FontSize="14"
                                                    TextColor="White"
                                                    BackgroundColor="{AppThemeBinding Light=#dc3545, Dark=#dc3545}"
                                                    WidthRequest="32"
                                                    HeightRequest="32"
                                                    CornerRadius="16"
                                                    Padding="0"
                                                    Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=RemoveApiKeyCommand}"
                                                    CommandParameter="{Binding .}">
                                                <Button.Shadow>
                                                    <Shadow Brush="Black" Offset="0,2" Radius="4" Opacity="0.2" />
                                                </Button.Shadow>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        
                        <BoxView HeightRequest="1"
                                 BackgroundColor="{AppThemeBinding Light=#e0e0e0, Dark=#555555}"
                                 Margin="0,20,0,16" />
                    </StackLayout>
                    
                    <!-- Add New API Key Section -->
                    <StackLayout>
                        <Label Text="Add New API Key:"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#ffffff}"
                               Margin="0,0,0,12" />
                        
                        <!-- Provider buttons grid -->
                        <Grid RowDefinitions="Auto,Auto" 
                              ColumnDefinitions="*,*" 
                              RowSpacing="12" 
                              ColumnSpacing="12">
                            
                            <Button Grid.Row="0" Grid.Column="0"
                                    Text="Groq"
                                    Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=SaveApiKeyCommand}"
                                    CommandParameter="Groq"
                                    BackgroundColor="{AppThemeBinding Light=#0078D7, Dark=#0078D7}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    HeightRequest="48"
                                    FontSize="14"
                                    FontAttributes="Bold" />
                            
                            <Button Grid.Row="0" Grid.Column="1"
                                    Text="OpenRouter"
                                    Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=SaveApiKeyCommand}"
                                    CommandParameter="OpenRouter"
                                    BackgroundColor="{AppThemeBinding Light=#0078D7, Dark=#0078D7}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    HeightRequest="48"
                                    FontSize="14"
                                    FontAttributes="Bold" />
                            
                            <Button Grid.Row="1" Grid.Column="0"
                                    Text="Anthropic"
                                    Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=SaveApiKeyCommand}"
                                    CommandParameter="Anthropic"
                                    BackgroundColor="{AppThemeBinding Light=#0078D7, Dark=#0078D7}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    HeightRequest="48"
                                    FontSize="14"
                                    FontAttributes="Bold" />
                            
                            <Button Grid.Row="1" Grid.Column="1"
                                    Text="OpenAI"
                                    Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=SaveApiKeyCommand}"
                                    CommandParameter="OpenAI"
                                    BackgroundColor="{AppThemeBinding Light=#0078D7, Dark=#0078D7}"
                                    TextColor="White"
                                    CornerRadius="8"
                                    HeightRequest="48"
                                    FontSize="14"
                                    FontAttributes="Bold" />
                        </Grid>
                    </StackLayout>
                    
                    <!-- Close button -->
                    <Button Text="Close"
                            Command="{Binding Source={x:Reference ApiKeyOverlayRoot}, Path=CloseOverlayCommand}"
                            BackgroundColor="Transparent"
                            BorderColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                            BorderWidth="1"
                            TextColor="{AppThemeBinding Light=#666666, Dark=#cccccc}"
                            CornerRadius="8"
                            HeightRequest="44"
                            Margin="0,8,0,0" />
                </StackLayout>
            </ScrollView>
        </Border>
    </Grid>
</ContentView>
