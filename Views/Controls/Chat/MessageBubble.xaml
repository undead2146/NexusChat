<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:NexusChat.Views.Converters"
             xmlns:controls="clr-namespace:NexusChat.Views.Controls"
             x:Class="NexusChat.Views.Controls.MessageBubble"
             x:Name="this">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:BoolToAlignmentConverter x:Key="BoolToAlignmentConverter" 
                                               TrueValue="Start" 
                                               FalseValue="End" />
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:MessageAuthorConverter x:Key="MessageAuthorConverter" />
            <converters:DateTimeToTimeStringConverter x:Key="DateTimeToTimeStringConverter" />
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid ColumnDefinitions="Auto,*,Auto" 
          Margin="8,4" 
          HorizontalOptions="{Binding IsAI, Source={x:Reference this}, Converter={StaticResource BoolToAlignmentConverter}}">
        
        <!-- AI Icon (only for AI messages) -->
        <Border Grid.Column="0" 
               StrokeShape="RoundRectangle 15"
               HeightRequest="30"
               WidthRequest="30"
               StrokeThickness="0"
               BackgroundColor="#6211DE"
               Margin="0,0,8,0"
               VerticalOptions="Start"
               IsVisible="{Binding IsAI, Source={x:Reference this}}">
            <Label Text="ðŸ¤–" 
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   FontSize="16" />
        </Border>

        <!-- Message Content Area -->
        <Grid Grid.Column="1"
              RowDefinitions="Auto,Auto"
              MaximumWidthRequest="280">
            
            <!-- Author Label (only for AI) -->
            <Label Grid.Row="0"
                   Text="{Binding IsAI, Source={x:Reference this}, Converter={StaticResource MessageAuthorConverter}}"
                   FontSize="12"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                   IsVisible="{Binding IsAI, Source={x:Reference this}}"
                   Margin="0,0,0,4" />

            <!-- Message Bubble -->
            <Border Grid.Row="1"
                   Padding="12,8"
                   StrokeThickness="0"
                   StrokeShape="RoundRectangle 16">
                
                <Border.Triggers>
                    <DataTrigger TargetType="Border"
                                 Binding="{Binding IsAI, Source={x:Reference this}}"
                                 Value="True">
                        <Setter Property="BackgroundColor" 
                                Value="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}" />
                    </DataTrigger>
                    <DataTrigger TargetType="Border"
                                 Binding="{Binding IsAI, Source={x:Reference this}}"
                                 Value="False">
                        <Setter Property="BackgroundColor" 
                                Value="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                    </DataTrigger>
                </Border.Triggers>
                
                <Grid RowDefinitions="Auto,Auto,Auto">
                    <!-- Thinking indicator for AI messages -->
                    <Grid x:Name="ThinkingGrid" 
                          Grid.Row="0" 
                          IsVisible="False"
                          HeightRequest="20">
                        <controls:ThinkingIndicator IsActive="True" />
                    </Grid>
                    
                    <!-- Message Content -->
                    <Label x:Name="ContentLabel"
                           Grid.Row="1"
                           Text="{Binding MessageContent, Source={x:Reference this}}"
                           LineBreakMode="WordWrap"
                           VerticalOptions="FillAndExpand">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label"
                                         Binding="{Binding IsAI, Source={x:Reference this}}"
                                         Value="True">
                                <Setter Property="TextColor" 
                                        Value="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}" />
                            </DataTrigger>
                            <DataTrigger TargetType="Label"
                                         Binding="{Binding IsAI, Source={x:Reference this}}"
                                         Value="False">
                                <Setter Property="TextColor" 
                                        Value="White" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                    
                    <!-- Footer with timestamp and regenerate button -->
                    <Grid Grid.Row="2" 
                          ColumnDefinitions="*,Auto"
                          Margin="0,4,0,0">
                        
                        <Label Grid.Column="0"
                               Text="{Binding Timestamp, Source={x:Reference this}, Converter={StaticResource DateTimeToTimeStringConverter}}"
                               FontSize="10"
                               VerticalOptions="End">
                            <Label.Triggers>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsAI, Source={x:Reference this}}"
                                             Value="True">
                                    <Setter Property="TextColor" 
                                            Value="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}" />
                                </DataTrigger>
                                <DataTrigger TargetType="Label"
                                             Binding="{Binding IsAI, Source={x:Reference this}}"
                                             Value="False">
                                    <Setter Property="TextColor" 
                                            Value="#CCFFFFFF" />
                                </DataTrigger>
                            </Label.Triggers>
                        </Label>
                        
                        <!-- Regenerate button for AI messages -->
                        <Button Grid.Column="1"
                               Text="ðŸ”„"
                               FontSize="12"
                               Padding="4"
                               BackgroundColor="Transparent"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                               WidthRequest="28"
                               HeightRequest="24"
                               VerticalOptions="End"
                               IsVisible="{Binding IsAI, Source={x:Reference this}}"
                               Command="{Binding Source={x:Reference this}, Path=RegenerateCommand}"
                               CommandParameter="{Binding Source={x:Reference this}, Path=Message}" />
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!-- User Icon (only for user messages) -->
        <Border Grid.Column="2" 
               StrokeShape="RoundRectangle 15"
               HeightRequest="30"
               WidthRequest="30"
               StrokeThickness="0"
               BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
               Margin="8,0,0,0"
               VerticalOptions="Start"
               IsVisible="{Binding IsAI, Source={x:Reference this}, Converter={StaticResource InvertedBoolConverter}}">
            <Label Text="ðŸ‘¤" 
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   FontSize="16" />
        </Border>
    </Grid>
</ContentView>
