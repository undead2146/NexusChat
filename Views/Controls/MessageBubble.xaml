<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:converters="clr-namespace:NexusChat.Views.Converters"
             xmlns:controls="clr-namespace:NexusChat.Views.Controls"
             x:Class="NexusChat.Views.Controls.MessageBubble"
             x:Name="this">

    <ContentView.Resources>
        <ResourceDictionary>
            <converters:BoolToAlignmentConverter x:Key="BoolToAlignmentConverter" 
                                               TrueValue="Start" 
                                               FalseValue="End" />
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:MessageAuthorConverter x:Key="MessageAuthorConverter" />
            <converters:DateTimeToTimeStringConverter x:Key="DateTimeToTimeStringConverter" />
            <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
            
            <!-- Define colors for message bubbles -->
            <Color x:Key="AIDarkBubbleColor">#303030</Color>
            <Color x:Key="AILightBubbleColor">#F0F0F0</Color>
            <Color x:Key="UserDarkBubbleColor">#0A84FF</Color>
            <Color x:Key="UserLightBubbleColor">#007AFF</Color>
            
            <!-- Text colors -->
            <Color x:Key="AIDarkTextColor">White</Color>
            <Color x:Key="AILightTextColor">Black</Color>
            <Color x:Key="UserTextColor">White</Color>
            
            <!-- Timestamp colors -->
            <Color x:Key="AIDarkTimestampColor">#909090</Color>
            <Color x:Key="AILightTimestampColor">#707070</Color>
            <Color x:Key="UserTimestampColor">White</Color>
        </ResourceDictionary>
    </ContentView.Resources>

    <Grid ColumnDefinitions="Auto,*,Auto" Margin="5" HorizontalOptions="{Binding IsAI, Source={x:Reference this}, Converter={StaticResource BoolToAlignmentConverter}}">
        <!-- Author Icon (only for AI) -->
        <Frame Grid.Column="0" 
               CornerRadius="15"
               HeightRequest="30"
               WidthRequest="30"
               Padding="0"
               IsClippedToBounds="True"
               BackgroundColor="White"
               Margin="0,0,5,0"
               VerticalOptions="Start"
               IsVisible="{Binding IsAI, Source={x:Reference this}}">
            <!-- Purple circle for AI icon -->
            <Ellipse Fill="#6211DE"
                    HeightRequest="26"
                    WidthRequest="26"
                    HorizontalOptions="Center"
                    VerticalOptions="Center" />
        </Frame>

        <!-- Message Content -->
        <VerticalStackLayout Grid.Column="1" Spacing="5">
            <!-- Author Display (only for AI) -->
            <Label Text="{Binding IsAI, Source={x:Reference this}, Converter={StaticResource MessageAuthorConverter}}"
                   FontSize="12"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                   IsVisible="{Binding IsAI, Source={x:Reference this}}" />

            <!-- Message Bubble -->
            <Frame x:Name="MessageFrame"
                   Padding="10"
                   HasShadow="False"
                   CornerRadius="12"
                   BorderColor="Transparent">
                
                <!-- Setup the frame background color -->
                <Frame.Triggers>
                    <DataTrigger TargetType="Frame"
                                 Binding="{Binding IsAI, Source={x:Reference this}}"
                                 Value="True">
                        <Setter Property="BackgroundColor" 
                                Value="{AppThemeBinding Light={StaticResource AILightBubbleColor}, Dark={StaticResource AIDarkBubbleColor}}" />
                    </DataTrigger>
                    <DataTrigger TargetType="Frame"
                                 Binding="{Binding IsAI, Source={x:Reference this}}"
                                 Value="False">
                        <Setter Property="BackgroundColor" 
                                Value="{AppThemeBinding Light={StaticResource UserLightBubbleColor}, Dark={StaticResource UserDarkBubbleColor}}" />
                    </DataTrigger>
                </Frame.Triggers>
                
                <VerticalStackLayout>
                    <!-- Thinking indicator display -->
                    <Grid IsVisible="False" x:Name="ThinkingGrid">
                        <controls:ThinkingIndicator IsActive="True" />
                    </Grid>
                    
                    <!-- Message Content -->
                    <Label x:Name="ContentLabel"
                           Text="{Binding MessageContent, Source={x:Reference this}}"
                           LineBreakMode="WordWrap">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label"
                                         Binding="{Binding IsAI, Source={x:Reference this}}"
                                         Value="True">
                                <Setter Property="TextColor" 
                                        Value="{AppThemeBinding Light={StaticResource AILightTextColor}, Dark={StaticResource AIDarkTextColor}}" />
                            </DataTrigger>
                            <DataTrigger TargetType="Label"
                                         Binding="{Binding IsAI, Source={x:Reference this}}"
                                         Value="False">
                                <Setter Property="TextColor" 
                                        Value="{StaticResource UserTextColor}" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                           
                    <!-- Timestamp -->
                    <Label Text="{Binding Timestamp, Source={x:Reference this}, Converter={StaticResource DateTimeToTimeStringConverter}}"
                           FontSize="10"
                           HorizontalOptions="End"
                           Margin="0,5,0,0">
                        <Label.Triggers>
                            <DataTrigger TargetType="Label"
                                         Binding="{Binding IsAI, Source={x:Reference this}}"
                                         Value="True">
                                <Setter Property="TextColor" 
                                        Value="{AppThemeBinding Light={StaticResource AILightTimestampColor}, Dark={StaticResource AIDarkTimestampColor}}" />
                            </DataTrigger>
                            <DataTrigger TargetType="Label"
                                         Binding="{Binding IsAI, Source={x:Reference this}}"
                                         Value="False">
                                <Setter Property="TextColor" 
                                        Value="{StaticResource UserTimestampColor}" />
                            </DataTrigger>
                        </Label.Triggers>
                    </Label>
                </VerticalStackLayout>
            </Frame>
        </VerticalStackLayout>

        <!-- User Icon (only for user messages) -->
        <Frame Grid.Column="2" 
               CornerRadius="15"
               HeightRequest="30"
               WidthRequest="30"
               Padding="0"
               IsClippedToBounds="True"
               BackgroundColor="{AppThemeBinding Light=#007AFF, Dark=#0A84FF}"
               Margin="5,0,0,0"
               VerticalOptions="Start"
               IsVisible="{Binding IsAI, Source={x:Reference this}, Converter={StaticResource InvertedBoolConverter}}">
            <Label Text="&#xf007;" 
                   FontFamily="FontAwesome-Solid"
                   TextColor="White"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   FontSize="16" />
        </Frame>
    </Grid>
</ContentView>
