<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:viewmodels="clr-namespace:NexusChat.Core.ViewModels"
             x:Class="NexusChat.Views.Pages.MainPage"
             x:Name="MainPageRoot"
             BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}">
    
    <Grid x:Name="MainGrid" RowDefinitions="*,Auto">
        <ScrollView Grid.Row="0">
            <!-- Simple background instead of gradient which might cause issues -->
            <VerticalStackLayout Padding="16,24,16,16" Spacing="18">
                
                <!-- App Header with theme toggle -->
                <Grid ColumnDefinitions="*,Auto" Margin="0,0,0,12">
                    <VerticalStackLayout Grid.Column="0" Spacing="4">
                        <Label Text="NexusChat" 
                               FontFamily="OpenSansBold" 
                               FontSize="28" 
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                        <Label Text="AI at your fingertips" 
                               FontFamily="OpenSansRegular" 
                               FontSize="16" 
                               TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}" />
                    </VerticalStackLayout>
                    
                    <!-- Simpler theme toggle button -->
                    <Frame Grid.Column="1"
                           Padding="0"
                           WidthRequest="48" HeightRequest="48"
                           CornerRadius="24"
                           HasShadow="False"
                           BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                           BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}">
                        <Label Text="{Binding ThemeIconText}"
                               FontFamily="FontAwesome-Solid"
                               FontSize="22"
                               FontAutoScalingEnabled="False"
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleThemeCommand}"/>
                        </Frame.GestureRecognizers>
                    </Frame>
                </Grid>
                
                <!-- Start Chat Panel - Enhanced with better favorites display -->
                <Frame Padding="0"
                       HasShadow="False"
                       BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                       CornerRadius="16">
                    <Grid RowDefinitions="Auto,Auto,Auto">
                        <!-- Simple header instead of gradient -->
                        <Grid Grid.Row="0"
                              BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                              Padding="20,16">
                            <Label Text="Start a Conversation"
                                   TextColor="White"
                                   FontFamily="OpenSansBold"
                                   FontSize="20"/>
                        </Grid>
                            
                        <!-- favorite Models area - NEW PROMINENT SECTION -->
                        <Grid Grid.Row="1" 
                              BackgroundColor="{AppThemeBinding Light=#FFF5E6, Dark=#332200}" 
                              Padding="16,12" 
                              IsVisible="{Binding HasfavoriteModels}">
                            <VerticalStackLayout Spacing="8">
                                <Label Text="Your favorite Models"
                                       FontFamily="OpenSansSemiBold"
                                       FontSize="16"
                                       TextColor="{AppThemeBinding Light=#CC7700, Dark=#FFCC66}"/>
                                       
                                <!-- Enhanced favorite Models Display -->
                                <CollectionView ItemsSource="{Binding favoriteModels}"
                                                HeightRequest="120"
                                                SelectionMode="None">
                                    <CollectionView.ItemsLayout>
                                        <GridItemsLayout Orientation="Vertical" 
                                                         Span="2" 
                                                         HorizontalItemSpacing="10" 
                                                         VerticalItemSpacing="10"/>
                                    </CollectionView.ItemsLayout>
                                    
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame Padding="12,10"
                                                   CornerRadius="10"
                                                   Margin="0"
                                                   BackgroundColor="{Binding ColorHex}"
                                                   HasShadow="True">
                                                <Grid RowDefinitions="Auto,*" RowSpacing="4">
                                                    <Label Text="{Binding Name}"
                                                           FontFamily="OpenSansBold"
                                                           FontSize="14"
                                                           TextColor="White"
                                                           LineBreakMode="TailTruncation"/>
                                                           
                                                    <Label Grid.Row="1"
                                                           Text="{Binding Provider}"
                                                           FontFamily="OpenSansRegular"
                                                           FontSize="12"
                                                           TextColor="#FFFFFFAA"
                                                           LineBreakMode="TailTruncation"/>
                                                </Grid>
                                                <Frame.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainPageViewModel}}, Path=SelectModelCommand}"
                                                                          CommandParameter="{Binding .}"/>
                                                </Frame.GestureRecognizers>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>
                            </VerticalStackLayout>
                        </Grid>
                            
                        <!-- Content area -->
                        <VerticalStackLayout Grid.Row="2" 
                                          Padding="20" 
                                          Spacing="20"
                                          BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}">
                                
                            <!-- Model selection message -->
                            <Label Text="{Binding ModelSelectionMessage}"
                                  FontFamily="OpenSansRegular"
                                  FontSize="14"
                                  TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                                  IsVisible="{Binding HasNofavoriteModels}"/>

                            <!-- Action Buttons -->
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="16">
                                <!-- Browse Models button -->
                                <Button Grid.Column="0"
                                      Text="Browse All Models"
                                      BorderWidth="1"
                                      BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                      TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                      BackgroundColor="Transparent"
                                      CornerRadius="8"
                                      HeightRequest="44"
                                      Command="{Binding ModelsCommand}"/>
                                        
                                <!-- Start Chat button -->
                                <Button Grid.Column="1"
                                      Text="Start New Chat"
                                      BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                      TextColor="White"
                                      CornerRadius="8"
                                      HeightRequest="44"
                                      Command="{Binding StartNewChatCommand}"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Grid>
                </Frame>
                
                <!-- Quick Action Cards - Simplified -->
                <Label Text="Quick Actions"
                     FontFamily="OpenSansBold"
                     FontSize="20"
                     Margin="4,0,0,4"
                     TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}" />
                    
                <Grid ColumnDefinitions="*,*" RowDefinitions="*,*" RowSpacing="16" ColumnSpacing="16">
                    <!-- Chats -->
                    <Frame Grid.Row="0" Grid.Column="0"
                         HasShadow="False"
                         BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                         CornerRadius="12"
                         Padding="16"
                         BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="&#xf4ad;"
                                 FontFamily="FontAwesome-Solid"
                                 FontSize="24"
                                 FontAutoScalingEnabled="False"
                                 TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                            <Label Text="Recent Chats"
                                 FontFamily="OpenSansSemiBold"
                                 FontSize="14"
                                 TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"/>
                        </VerticalStackLayout>
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ChatsCommand}"/>
                        </Frame.GestureRecognizers>
                    </Frame>
                        
                    <!-- Models -->
                    <Frame Grid.Row="0" Grid.Column="1"
                         HasShadow="False"
                         BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                         CornerRadius="12"
                         Padding="16"
                         BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="&#xf085;"
                                 FontFamily="FontAwesome-Solid"
                                 FontSize="24"
                                 FontAutoScalingEnabled="False"
                                 TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                            <Label Text="AI Models"
                                 FontFamily="OpenSansSemiBold"
                                 FontSize="14"
                                 TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"/>
                        </VerticalStackLayout>
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ModelsCommand}"/>
                        </Frame.GestureRecognizers>
                    </Frame>
                        
                    <!-- Settings -->
                    <Frame Grid.Row="1" Grid.Column="0"
                         HasShadow="False"
                         BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                         CornerRadius="12"
                         Padding="16"
                         BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="&#xf013;"
                                 FontFamily="FontAwesome-Solid"
                                 FontSize="24"
                                 FontAutoScalingEnabled="False"
                                 TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                            <Label Text="Settings"
                                 FontFamily="OpenSansSemiBold"
                                 FontSize="14"
                                 TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"/>
                        </VerticalStackLayout>
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding SettingsCommand}"/>
                        </Frame.GestureRecognizers>
                    </Frame>
                        
                    <!-- Profile -->
                    <Frame Grid.Row="1" Grid.Column="1"
                         HasShadow="False"
                         BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                         CornerRadius="12"
                         Padding="16"
                         BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}">
                        <VerticalStackLayout Spacing="8">
                            <Label Text="&#xf007;"
                                 FontFamily="FontAwesome-Solid"
                                 FontSize="24"
                                 FontAutoScalingEnabled="False"
                                 TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"/>
                            <Label Text="Profile"
                                 FontFamily="OpenSansSemiBold"
                                 FontSize="14"
                                 TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"/>
                        </VerticalStackLayout>
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ProfileCommand}"/>
                        </Frame.GestureRecognizers>
                    </Frame>
                </Grid>
                
                <!-- Dev Tools Section - Simplified -->
                <Frame Padding="16"
                     HasShadow="False"
                     BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                     CornerRadius="12"
                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}">
                    <VerticalStackLayout Spacing="12">
                        <Label Text="Developer Tools"
                             FontFamily="OpenSansBold"
                             FontSize="18"
                             TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"/>
                            
                        <!-- Clicker Game simplified with fixed binding -->
                        <Grid ColumnDefinitions="*,Auto" RowSpacing="8" Margin="0,0,0,12">
                            <Label Text="{Binding MaxComboScore, StringFormat='Clicker Game - High Score: {0}'}"
                                 Grid.Column="0"
                                 FontFamily="OpenSansRegular"
                                 FontSize="14"
                                 TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"/>
                                    
                            <Button x:Name="CounterBtn"
                                  Grid.Column="1"
                                  Text="PLAY"
                                  Command="{Binding CounterClickCommand}"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                  TextColor="White"
                                  CornerRadius="8"
                                  HeightRequest="36"
                                  WidthRequest="70"/>
                        </Grid>
                            
                        <!-- Dev Tool buttons - Horizontal plain buttons -->
                        <HorizontalStackLayout Spacing="12" HorizontalOptions="Start">
                            <Button Text="Themes"
                                  Command="{Binding NavigateToThemesCommand}"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                  TextColor="White"
                                  CornerRadius="8"
                                  HeightRequest="36"/>
                                        
                            <Button Text="Tests"
                                  Command="{Binding RunModelTestsCommand}"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                  TextColor="White"
                                  CornerRadius="8"
                                  HeightRequest="36"/>
                                        
                            <Button Text="DB View"
                                  Command="{Binding ViewDatabaseCommand}"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                  TextColor="White"
                                  CornerRadius="8"
                                  HeightRequest="36"/>

                            <Button Text="Model Debug"
                                  Command="{Binding ModelDebugCommand}"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                  TextColor="White"
                                  CornerRadius="8"
                                  HeightRequest="36"/>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>
                
                <!-- App Version -->
                <Label Text="NexusChat v0.5.0 (Alpha)"
                     HorizontalOptions="Center"
                     FontSize="12"
                     Margin="0,6,0,12"
                     TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"/>
            </VerticalStackLayout>
        </ScrollView>
        
        <!-- Bottom Navigation - Simplified -->
        <Grid Grid.Row="1" 
            ColumnDefinitions="*,*,*"
            BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}"
            HeightRequest="60">
            
            <!-- Home tab - Active -->
            <VerticalStackLayout Grid.Column="0"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Spacing="4">
                <Label Text="&#xf015;"
                     FontFamily="FontAwesome-Solid"
                     FontSize="22"
                     FontAutoScalingEnabled="False"
                     TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                     HorizontalOptions="Center"/>
                <Label Text="Home"
                     FontSize="12"
                     TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                     FontAttributes="Bold"
                     HorizontalOptions="Center"/>
                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding HomeCommand}"/>
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
            
            <!-- Chats tab -->
            <VerticalStackLayout Grid.Column="1" 
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Spacing="4">
                <Label Text="&#xf4ad;"
                     FontFamily="FontAwesome-Solid"
                     FontSize="22"
                     FontAutoScalingEnabled="False"
                     TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                     HorizontalOptions="Center"/>
                <Label Text="Chats"
                     FontSize="12"
                     TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                     HorizontalOptions="Center"/>
                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ChatsCommand}"/>
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
            
            <!-- Profile tab -->
            <VerticalStackLayout Grid.Column="2" 
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Spacing="4">
                <Label Text="&#xf007;"
                     FontFamily="FontAwesome-Solid"
                     FontSize="22"
                     FontAutoScalingEnabled="False"
                     TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                     HorizontalOptions="Center"/>
                <Label Text="Profile"
                     FontSize="12"
                     TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                     HorizontalOptions="Center"/>
                <VerticalStackLayout.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ProfileCommand}"/>
                </VerticalStackLayout.GestureRecognizers>
            </VerticalStackLayout>
        </Grid>
    </Grid>
</ContentPage>
