<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converters="clr-namespace:NexusChat.Views.Converters"
             x:Class="NexusChat.Views.Pages.DevTools.DatabaseViewerPage"
             BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
             Shell.NavBarIsVisible="False"
             Title="Database Viewer">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
            <converters:FormatStringConverter x:Key="FormatStringConverter" />
            <converters:GreaterThanConverter x:Key="GreaterThanConverter" />
            <converters:PageInfoConverter x:Key="PageInfoConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" RowSpacing="0">
        <!-- Custom Header -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto"
              BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
              Padding="15,12">
            <!-- Back Button - Fix Icon Font -->
            <Button Grid.Column="0"
                    Text="&#xf060;"
                    FontFamily="FontAwesome-Solid"
                    FontSize="22"
                    Command="{Binding GoBackCommand}"
                    BackgroundColor="Transparent"
                    TextColor="White"
                    BorderColor="Transparent"
                    WidthRequest="50"
                    HeightRequest="50"
                    Padding="0"
                    CornerRadius="25"
                    HorizontalOptions="Start"
                    VerticalOptions="Center" />

            <!-- Title -->
            <Label Grid.Column="1"
                   Text="Database Viewer"
                   FontFamily="OpenSansBold"
                   TextColor="White"
                   FontSize="20"
                   VerticalOptions="Center"
                   HorizontalOptions="Start" />
                   
            <!-- Record Count -->
            <Label Grid.Column="2"
                   Text="{Binding RecordCount}"
                   TextColor="White"
                   HorizontalOptions="End"
                   VerticalOptions="Center" />
        </Grid>
        
        <!-- Main Content -->
        <Grid Grid.Row="1" RowDefinitions="Auto,Auto,Auto,*,Auto" Padding="15" RowSpacing="10">
            <!-- Table Selection and Controls -->
            <Frame Grid.Row="0" 
                   BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}"
                   Padding="15" Margin="0,15,0,0"
                   BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">
                <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                    <Label Grid.Column="0" 
                           Text="&#xf0ce;"
                           FontFamily="FontAwesome-Solid"
                           FontSize="20"
                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                           VerticalOptions="Center"
                           Margin="0,0,5,0"
                           FontAutoScalingEnabled="False" />
                           
                    <Picker Grid.Column="1" 
                            ItemsSource="{Binding Tables}" 
                            SelectedItem="{Binding SelectedTable}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"
                            VerticalOptions="Center">
                        <Picker.Behaviors>
                            <toolkit:EventToCommandBehavior
                                EventName="SelectedIndexChanged"
                                Command="{Binding TableChangedCommand}"
                                CommandParameter="{Binding SelectedTable}" />
                        </Picker.Behaviors>
                    </Picker>
                    
                    <!-- Cancel button - show when busy -->
                    <Button Grid.Column="2"
                            Text="Cancel"
                            Command="{Binding CancelOperationCommand}"
                            IsVisible="{Binding IsBusy}"
                            BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}"
                            TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"
                            FontSize="14"
                            CornerRadius="5"
                            Padding="10,5"
                            VerticalOptions="Center"
                            Margin="0,0,5,0" />
                    
                    <!-- Refresh button -->
                    <Frame Grid.Column="2"
                           BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                           HeightRequest="36"
                           WidthRequest="36"
                           CornerRadius="18"
                           Padding="0"
                           HasShadow="False"
                           IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                           BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">
                        <Button Text="&#xf2f1;"
                                FontFamily="FontAwesome-Solid" 
                                Command="{Binding RefreshDataCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                FontSize="16"
                                VerticalOptions="Center"
                                FontAutoScalingEnabled="False"
                                WidthRequest="36"
                                HeightRequest="36"
                                CornerRadius="18"
                                Padding="0"
                                Margin="0" />
                    </Frame>
                            
                    <Button Grid.Column="3"
                            Text="&#xf1f8;"
                            FontFamily="FontAwesome-Solid" 
                            Command="{Binding ClearDatabaseCommand}"
                            BackgroundColor="{AppThemeBinding Light=#f8d7da, Dark=#6e1a21}"
                            TextColor="{AppThemeBinding Light=#721c24, Dark=#f8d7da}"
                            BorderWidth="0"
                            CornerRadius="18"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            VerticalOptions="Center"
                            FontAutoScalingEnabled="False" />
                </Grid>
            </Frame>
            
            <!-- Search and Page Size Controls in one row -->
            <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
                <!-- Page Size Selector -->
                <HorizontalStackLayout Grid.Column="0" Spacing="5" VerticalOptions="Center">
                    <Label Text="Page Size:"
                           TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                           VerticalOptions="Center" />
                    <Picker SelectedItem="{Binding PageSize}" 
                            WidthRequest="80"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}">
                        <Picker.ItemsSource>
                            <x:Array Type="{x:Type x:Int32}">
                                <x:Int32>10</x:Int32>
                                <x:Int32>20</x:Int32>
                                <x:Int32>50</x:Int32>
                                <x:Int32>100</x:Int32>
                            </x:Array>
                        </Picker.ItemsSource>
                    </Picker>
                </HorizontalStackLayout>
                

                <!-- Search Entry -->
                <Grid Grid.Column="2" ColumnDefinitions="Auto,*" WidthRequest="200">
                    <Label Grid.Column="0"
                           Text="&#xf002;" 
                           FontFamily="FontAwesome-Solid"
                           FontSize="16"
                           TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                           VerticalOptions="Center"
                           Margin="0,0,5,0"
                           FontAutoScalingEnabled="False" />
                    <Entry Grid.Column="1"
                           Placeholder="Search..."
                           Text="{Binding SearchText}"
                           BackgroundColor="Transparent"
                           TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"
                           PlaceholderColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}" />
                </Grid>
            </Grid>
            
            <!-- Status Message - Now in its own row -->
            <Label Grid.Row="2"
                   Text="{Binding StatusMessage}" 
                   TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                   VerticalOptions="Center"
                   HorizontalOptions="Start"
                   LineBreakMode="NoWrap"
                   MaxLines="1"
                   Margin="0,5"/>
            
            <!-- Main Data Container - Compacted to avoid excess space -->
            <Grid Grid.Row="3">
                <!-- Loading Indicator -->
                <Grid IsVisible="{Binding IsBusy}"
                      BackgroundColor="{AppThemeBinding Light=#80FFFFFF, Dark=#80000000}"
                      ZIndex="10">
                    <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                           CornerRadius="10"
                           WidthRequest="120"
                           HeightRequest="120"
                           HorizontalOptions="Center"
                           VerticalOptions="Center"
                           Padding="15"
                           BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">
                        <VerticalStackLayout Spacing="10" HorizontalOptions="Center" VerticalOptions="Center">
                            <ActivityIndicator IsRunning="True"
                                               Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                               WidthRequest="40"
                                               HeightRequest="40" />
                            <Label Text="Loading..."
                                   TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>
                </Grid>

                <!-- No Data Message - Shown when HasNoDataAndNotBusy is true -->
                <Frame IsVisible="{Binding HasNoDataAndNotBusy}"
                       BackgroundColor="{AppThemeBinding Light={StaticResource CardBackground}, Dark={StaticResource CardBackgroundDark}}"
                       Padding="20" 
                       BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                       ZIndex="0">
                    <VerticalStackLayout Spacing="15" HorizontalOptions="Center" VerticalOptions="Center">
                        <Label Text="&#xf542;"
                               FontFamily="FontAwesome-Solid"
                               FontSize="32"
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                               HorizontalOptions="Center"
                               FontAutoScalingEnabled="False" />
                               
                        <Label Text="No data available in this table" 
                               FontFamily="OpenSansSemiBold"
                               TextColor="{AppThemeBinding Light={StaticResource PrimaryTextColor}, Dark={StaticResource PrimaryTextColorDark}}"
                               HorizontalOptions="Center" />
                            
                        <Label Text="Use the Model Testing page to generate random test data"
                               TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}"
                               HorizontalOptions="Center"
                               FontSize="14" />
                    </VerticalStackLayout>
                </Frame>
            
                <!-- Table Container - Shown when HasData is true -->
                <Grid IsVisible="{Binding HasData}" ZIndex="1">
                    <!-- Data Table Container with improved scrolling -->
                    <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Background}, Dark={StaticResource BackgroundDark}}"
                           Padding="0"
                           BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}">
                        <ScrollView Orientation="Both" HorizontalScrollBarVisibility="Always">
                            <Grid x:Name="DataGrid" 
                                  StyleId="DataGrid"
                                  Padding="1"
                                  ColumnSpacing="1"
                                  RowSpacing="1"
                                  BackgroundColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray700}}" />
                        </ScrollView>
                    </Frame>
                </Grid>
            </Grid>
            
            <!-- Pagination controls - Now with just Previous and Next buttons -->
            <Grid Grid.Row="4" 
                  IsVisible="{Binding HasData}" 
                  ColumnDefinitions="Auto,*,Auto"
                  ColumnSpacing="10">
                <!-- Previous Page Button -->
                <Button Grid.Column="0"
                        Text="Previous"
                        Command="{Binding PreviousPageCommand}"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                        TextColor="{AppThemeBinding Light={StaticResource OnSecondary}, Dark={StaticResource OnSecondaryDark}}"
                        CornerRadius="5"
                        Padding="15,8"
                        HorizontalOptions="Start" />
                
                <!-- Page Info - Center - Using PageInfoConverter -->
                <Label Grid.Column="1"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource SecondaryTextColor}, Dark={StaticResource SecondaryTextColorDark}}">
                    <Label.Text>
                        <MultiBinding Converter="{StaticResource PageInfoConverter}">
                            <Binding Path="CurrentPage" />
                            <Binding Path="TotalPages" />
                        </MultiBinding>
                    </Label.Text>
                </Label>
                
                <!-- Next Page Button -->
                <Button Grid.Column="2"
                        Text="Next"
                        Command="{Binding NextPageCommand}"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                        TextColor="{AppThemeBinding Light={StaticResource OnSecondary}, Dark={StaticResource OnSecondaryDark}}"
                        CornerRadius="5"
                        Padding="15,8"
                        HorizontalOptions="End" />
            </Grid>
        </Grid>
    </Grid>
</ContentPage>
