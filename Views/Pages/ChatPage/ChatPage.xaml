<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:NexusChat.Core.ViewModels"
             xmlns:models="clr-namespace:NexusChat.Core.Models"
             xmlns:controls="clr-namespace:NexusChat.Views.Controls"
             x:Class="NexusChat.Views.Pages.ChatPage"
             x:DataType="viewmodels:ChatViewModel"
             Title="Chat"
             Shell.NavBarIsVisible="False"
             Shell.TabBarIsVisible="False">

    <Grid>
        <!-- Main chat content with safe area handling -->
        <Grid x:Name="MainContent" RowDefinitions="Auto,*,Auto">
            <!-- Header with safe area top padding -->
            <controls:ChatHeader Grid.Row="0"
                                Title="{Binding Title}"
                                CurrentModelName="{Binding CurrentModelName}"
                                MenuCommand="{Binding ToggleSidebarCommand}"
                                SwitchModelCommand="{Binding ChangeModelCommand}"
                                OptionsCommand="{Binding ShowMenuCommand}"
                                Padding="{OnPlatform iOS='0,47,0,0', Android='0,0,0,0', Default='0,0,0,0'}" />
            
            <!-- Messages -->
            <CollectionView x:Name="MessageCollectionView"
                            Grid.Row="1" 
                            ItemsSource="{Binding Messages}"
                            BackgroundColor="{AppThemeBinding Light=#f8f9fa, Dark=#1a1a1a}"
                            ItemSizingStrategy="MeasureAllItems"
                            RemainingItemsThreshold="5"
                            RemainingItemsThresholdReached="OnRemainingItemsThresholdReached"
                            VerticalScrollBarVisibility="Default">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Message">
                        <controls:MessageBubble Message="{Binding}"
                                               RegenerateCommand="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ChatViewModel}}, Path=RegenerateMessageCommand}"
                                               Margin="0,4" />
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            
            <!-- Input Area with safe area bottom padding -->
            <Grid Grid.Row="2" 
                  ColumnDefinitions="*,Auto" 
                  Padding="{OnPlatform iOS='12,12,12,34', Android='12,12,12,12', Default='12'}"
                  BackgroundColor="{AppThemeBinding Light=#ffffff, Dark=#2d2d2d}">
                <Editor x:Name="MessageEditor"
                        Grid.Column="0"
                        Placeholder="Type a message..."
                        Text="{Binding Message}"
                        BackgroundColor="{AppThemeBinding Light=#f0f0f0, Dark=#404040}"
                        Completed="OnEditorCompleted"
                        HeightRequest="40" />
                <Button Grid.Column="1"
                        Text="Send"
                        Command="{Binding SendMessageCommand}"
                        Clicked="OnSendButtonClicked"
                        Margin="8,0,0,0" />
            </Grid>
        </Grid>

        <!-- Sidebar with safe area handling -->
        <Grid x:Name="SidebarContainer"
              WidthRequest="300"
              HorizontalOptions="Start"
              BackgroundColor="{AppThemeBinding Light=#ffffff, Dark=#2d2d2d}"
              IsVisible="{Binding IsSidebarOpen}"
              Padding="{OnPlatform iOS='0,47,0,34', Android='0,0,0,0', Default='0,0,0,0'}">
            <controls:ConversationsSidebar x:Name="SidebarContent" />
        </Grid>

        <!-- Sidebar overlay - only visible outside sidebar area -->
        <Grid x:Name="SidebarOverlay"
              IsVisible="{Binding IsSidebarOpen}"
              BackgroundColor="Transparent">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>
            
            <!-- Transparent area over sidebar content -->
            <BoxView Grid.Column="0" 
                     BackgroundColor="Transparent" />
            
            <!-- Clickable overlay area outside sidebar -->
            <BoxView Grid.Column="1"
                     BackgroundColor="Black"
                     Opacity="0.5">
                <BoxView.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ToggleSidebarCommand}" />
                </BoxView.GestureRecognizers>
            </BoxView>
        </Grid>
    </Grid>

</ContentPage>
