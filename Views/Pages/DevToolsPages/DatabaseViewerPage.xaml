<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="NexusChat.Views.DatabaseViewerPage"
             Title="Database Viewer">
    
    <Grid RowDefinitions="Auto,*,Auto" Padding="15">
        <!-- Header and Controls -->
        <Grid Grid.Row="0" RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" Margin="0,0,0,15">
            <Label Grid.Row="0" Grid.Column="0"
                   Text="Database Viewer" 
                   Style="{StaticResource HeaderLabelStyle}" />
            
            <Label Grid.Row="0" Grid.Column="1"
                   Text="{Binding RecordCount}" 
                   HorizontalOptions="End"
                   VerticalOptions="Center" />
                   
            <HorizontalStackLayout Grid.Row="1" Grid.ColumnSpan="2" Spacing="10" Margin="0,10,0,0">
                <Label Text="Table:" VerticalOptions="Center" />
                <Picker ItemsSource="{Binding Tables}" 
                        SelectedItem="{Binding SelectedTable}"
                        WidthRequest="150"
                        VerticalOptions="Center">
                    <Picker.Behaviors>
                        <toolkit:EventToCommandBehavior
                            EventName="SelectedIndexChanged"
                            Command="{Binding TableChangedCommand}"
                            CommandParameter="{Binding SelectedTable}" />
                    </Picker.Behaviors>
                </Picker>
                
                <Button Text="Refresh" 
                        Command="{Binding RefreshDataCommand}"
                        WidthRequest="100"
                        Margin="10,0,0,0"
                        VerticalOptions="Center" />
            </HorizontalStackLayout>
        </Grid>
        
        <!-- Database Content -->
        <Grid Grid.Row="1">
            <!-- Remove the RefreshView which adds an extra loading indicator -->
            <ScrollView>
                <Grid RowDefinitions="Auto,*">
                    <!-- Status Message -->
                    <Label Grid.Row="0" Text="{Binding StatusMessage}" 
                           TextColor="{StaticResource SecondaryTextColor}"
                           Margin="0,0,0,10" />
                           
                    <!-- No Data View -->
                    <VerticalStackLayout Grid.Row="1" IsVisible="{Binding HasData, Converter={StaticResource InvertedBoolConverter}}"
                                        VerticalOptions="Start" HorizontalOptions="Fill">
                        <Frame BackgroundColor="{AppThemeBinding Light=#f8f9fa, Dark=#333}" 
                                Padding="20" CornerRadius="8">
                            <VerticalStackLayout Spacing="20">
                                <Label Text="No data available in this table" 
                                       HorizontalOptions="Center"
                                       TextColor="{StaticResource SecondaryTextColor}" />
                                
                                <Label Text="Use the Model Testing page to generate random test data"
                                       HorizontalOptions="Center"
                                       TextColor="{StaticResource SecondaryTextColor}"
                                       FontSize="Small" />
                            </VerticalStackLayout>
                        </Frame>
                    </VerticalStackLayout>
                    
                    <!-- Data Grid -->
                    <ScrollView Grid.Row="1" IsVisible="{Binding HasData}" Orientation="Both">
                        <Grid x:Name="DataGrid" ColumnSpacing="1" RowSpacing="1" Padding="1" 
                              BackgroundColor="{StaticResource Gray300}">
                            <!-- Grid content will be generated dynamically in code -->
                        </Grid>
                    </ScrollView>
                </Grid>
            </ScrollView>
            
            <!-- Single loading indicator for all operations -->
            <ActivityIndicator x:Name="LoadingIndicator" 
                               IsVisible="{Binding IsBusy}" 
                               IsRunning="{Binding IsBusy}"
                               VerticalOptions="Center" 
                               HorizontalOptions="Center" 
                               HeightRequest="50" 
                               WidthRequest="50" />
        </Grid>
        
        <!-- Footer with action buttons -->
        <Grid Grid.Row="2" ColumnDefinitions="*,*" Margin="0,15,0,0" ColumnSpacing="10">
            <Button Grid.Column="0" 
                    Text="Clear Database"
                    Command="{Binding ClearDatabaseCommand}"
                    BackgroundColor="{StaticResource Danger}"
                    TextColor="White"
                    IsEnabled="{Binding IsNotBusy}"
                    HorizontalOptions="Fill" />
                    
            <Button Grid.Column="1" 
                    Text="Close"
                    Command="{Binding GoBackCommand}"
                    IsEnabled="{Binding IsNotBusy}"
                    HorizontalOptions="Fill" />
        </Grid>
    </Grid>
</ContentPage>
